<script>
    // --- 變更開始 ---

    // 1. 將獎項內容和設定狀態宣告成全域變數，並給予預設值
    let prizePool = [];
    let rawInput = "[特獎]*1\n二獎*2\n三獎*5"; // 預設獎項內容
    let removeAfterDrawState = true; // 「抽後刪除」的預設狀態

    // --- 變更結束 ---

    function parsePrizeInput(input) {
      // --- 變更開始 ---
      // 2. 刪除這行，不然每次更新都會重置為預設值
      // document.getElementById("inputPrizes").value = "[特獎]*1\n二等獎*2";
      // --- 變更結束 ---

      const lines = input.trim().split('\n');
      const result = [];
      lines.forEach(line => {
        const match = line.match(/^(.+?)(\*(\d+))?$/);
        if (match) {
          const name = match[1].trim();
          const count = parseInt(match[3] || 1);
          for (let i = 0; i < count; i++) result.push(name);
        }
      });
      return result;
    }

    function updatePrizePoolDisplay() {
      const remaining = prizePool.length;
      document.getElementById("remainingCount").textContent = `剩餘：${remaining} 顆`;
    }

    function updatePrizes() {
      const input = document.getElementById("inputPrizes").value;
      
      // --- 變更開始 ---
      // 3. 按下更新時，儲存目前的設定到全域變數中
      rawInput = input;
      removeAfterDrawState = document.getElementById("removeAfterDraw").checked;
      // --- 變更結束 ---

      prizePool = parsePrizeInput(input);
      updatePrizePoolDisplay();
      toggleSettings(true); // 直接關閉設定面板
    }

    function toggleSettings(forceClose = null) {
      const panel = document.getElementById("settingsPanel");
      const resultElement = document.getElementById("result");
      resultElement.style.display = 'none';
      resultElement.style.opacity = '0';
      
      const shouldDisplay = forceClose === null ? panel.style.display !== "block" : !forceClose;

      if (shouldDisplay) {
        // --- 變更開始 ---
        // 4. 打開設定面板前，從變數讀取儲存的設定並顯示
        document.getElementById("inputPrizes").value = rawInput;
        document.getElementById("removeAfterDraw").checked = removeAfterDrawState;
        // --- 變更結束 ---
        panel.style.display = "block";
      } else {
        panel.style.display = "none";
      }
    }

    document.addEventListener("click", function (e) {
      const panel = document.getElementById("settingsPanel");
      const settingsBtn = document.querySelector(".settings-btn");
      if (!panel.contains(e.target) && !settingsBtn.contains(e.target)) {
        toggleSettings(true);
      }
    });

    function getRandomColor() {
      const colors = ['#ffd700', '#66ccff', '#ff99cc', '#ff6666', '#cc99ff', '#99ff99'];
      const random = () => colors[Math.floor(Math.random() * colors.length)];
      return `radial-gradient(circle, #fff 30%, ${random()} 70%)`;
    }

    function isSSRPrize(name) {
      return name.startsWith("[") && name.endsWith("]");
    }

    function cleanPrizeName(name) {
      return name.replace(/^\[|\]$/g, "");
    }

    function spinGacha() {
      const gachaButton = document.getElementById('gachaButton');
      const gachaBalls = document.getElementById('gachaBalls');
      const selectedBall = document.getElementById('selectedBall');
      const resultElement = document.getElementById('result');
      const machine = document.querySelector('.gacha-machine');
      
      // --- 變更開始 ---
      // 5. 抽獎時，直接讀取儲存的狀態變數
      const removeAfterDraw = removeAfterDrawState;
      // --- 變更結束 ---

      resultElement.style.display = 'none';
      selectedBall.style.display = 'none';
      resultElement.classList.remove("ssr-effect");

      if (prizePool.length === 0) {
        alert("目前沒有扭蛋可以抽囉！");
        return;
      }

      document.getElementById("drawSound").play();
      gachaButton.disabled = true;
      gachaBalls.classList.add('shake');

      setTimeout(() => {
        gachaBalls.classList.remove('shake');
        selectedBall.style.background = getRandomColor();
        selectedBall.style.display = 'block';
        
        const randomIndex = Math.floor(Math.random() * prizePool.length);
        const rawPrize = prizePool[randomIndex];
        const isSSR = isSSRPrize(rawPrize);
        const prize = cleanPrizeName(rawPrize);
        
        if (isSSR) {
          machine.classList.add('flash-bg');
        }

        setTimeout(() => {
          resultElement.textContent = prize;
          resultElement.style.display = 'block';
          resultElement.classList.toggle("ssr-effect", isSSR);
          gachaButton.disabled = false;

          if (removeAfterDraw) {
            prizePool.splice(randomIndex, 1);
            updatePrizePoolDisplay();
          }

          setTimeout(() => {
            machine.classList.remove('flash-bg');
          }, 2000);
        }, 1000);
      }, 1000);
    }

    // --- 變更開始 ---
    // 6. 預設載入時，將預設值填入設定面板，然後呼叫 updatePrizes() 初始化獎池
    window.onload = () => {
      document.getElementById('inputPrizes').value = rawInput;
      document.getElementById('removeAfterDraw').checked = removeAfterDrawState;
      updatePrizes();
    };
    // --- 變更結束 ---
  </script>
