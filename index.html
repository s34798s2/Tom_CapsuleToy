<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Tom's fun gashapon machine offers an online random draw feature, allowing customizable prize items and quantities.">
  <title>Gashapon machine</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
     @font-face {
	  font-family: 'Zpix';
	  src: url('zpix.ttf') format('truetype');
	  font-weight: normal;
	  font-style: normal;
	}
	 
	 
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: black; /* 設置網頁背景為黑色 */
    }

    body {
      font-family: 'Press Start 2P', 'Zpix', monospace;
      letter-spacing: 1px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    body::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.1); /* ✅ 可選：淡黑色遮罩讓前景更清楚 */
      z-index: -1;
    }

    .settings-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    .settings-panel {
      position: absolute;
      top: 60px;
      right: 12px;
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      display: none;
      z-index: 10;
      width: 250px;
    }

    .settings-panel textarea {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
    }

    .settings-panel input[type="checkbox"] {
      margin-right: 5px;
    }

    .settings-panel button {
      float: right;
      margin-top: 10px;
    }

    .gacha-container {
      text-align: center;
    }
	
	.gacha-machine-wrapper {
	  position: relative;
	  width: 500px;  /* ✅ 固定大小 */
	  height: 750px;
	  background-image: url('picture.jpg');  /* ✅ 扭蛋背景圖 */
	  background-size: cover;
	  background-position: center;
	  background-repeat: no-repeat;
	  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
	}

	  .gacha-machine {
		  position: absolute;
		  top: 0;
		  left: 0;
		  width: 100%;     /* 滿版放在 wrapper 裡 */
		  height: 100%;
		  pointer-events: none;  /* 防止點擊穿透，如果有需要 */
		}

	.gacha-balls {
	  position: absolute;
	  top: 80px;    /* ✅ 絕對座標定位 */
	  left: 50%;
	  transform: translateX(-50%);
	  width: 100%;
	  display: flex;
	  justify-content: center;
	  flex-wrap: wrap;
	  pointer-events: auto;  /* 要能點擊就打開 */
	}

   

	.selected-ball {
	  position: absolute;
	  top: 65%;
	  left: 50%;
	  transform: translateX(-50%);
	  width: 80px;
	  height: 80px;
	  border-radius: 50%; /* 雖然是復古，但圓形還是可以保留，或者看您想改成方形也可以喔！ */
	  display: none;
	  justify-content: center;
	  flex-wrap: wrap;
	  animation: bounceOut 2s ease-out forwards;
	  z-index: 3;

	  /* 復古遊戲風格新增部分 */
	  image-rendering: pixelated; /* 讓圖片或背景圖呈現像素化效果 */
	  box-shadow: 
		4px 4px 0px rgba(0, 0, 0, 0.8), /* 模擬像素邊框的陰影 */
		-4px -4px 0px rgba(255, 255, 255, 0.3); /* 另一邊的陰影，增加立體感 */
	  border: 2px solid #333; /* 增加一個深色邊框 */
	  background-color: #A0A0A0; /* 給一個比較灰暗的背景色，像以前的遊戲畫面 */

	}

	.gacha-result {
	  font-family: 'Zpix', monospace;
	  letter-spacing: 1px;
	  position: absolute;
	  top: 40%;
	  left: 50%;
	  transform: translateX(-50%);
	  padding: 20px 40px;
	  font-size: 30px;
	  font-weight: bold;

	  background-color: #000000; /* 黑底 */
	  color: #00FF00; /* 綠色字，CRT 復古感 */
	  
	  border: 5px solid #00FF00; /* 粗綠邊框 */
	  border-radius: 0; /* 方角 */
	  
	  box-shadow: 
		4px 4px 0 #006400,  /* 深綠陰影，製造像素立體感 */
		0 0 10px #00FF00;   /* 螢光感 */
	  
	  opacity: 0;
	  display: none;
	  
	  animation: reveal 1s 1.5s forwards;
	  
	  z-index: 10;
	}

	/* 漸顯動畫 */
	@keyframes reveal {
	  to {
		opacity: 1;
		display: block;
	  }
	}

	.gacha-button {
	  font-family: 'Press Start 2P', 'Zpix', monospace;
	  letter-spacing: 1px;
	  position: absolute;
	  bottom: 38px;
	  left: 50%;
	  transform: translateX(-50%);
	  padding: 12px 24px;
	  font-size: 24px;

	  background-color: #ffcc00; /* 黃色底 */
	  color: #000000; /* 黑色字 */
	  border: 4px solid #000; /* 黑框 */
	  box-shadow: 4px 4px 0 #333; /* 側邊陰影，做出立體感 */
	  border-radius: 0; /* 方角符合像素風格 */
	  
	  cursor: pointer;
	  z-index: 2;
	  transition: all 0.1s ease-in-out;
	}

	.gacha-button:active {
	  box-shadow: 0 0 0 #333;
	  transform: translateX(-50%) translateY(4px);
	}

    .remaining-count {
	  margin-top: 30px;  
	  margin-bottom: 10px;
	  font-size: 26px;
	  font-weight: bold;
	  text-align: center;   
	  width: 100%;            
	  color: #ff69b4; 
	}


    @keyframes bounceOut {
	  0% { transform: translateX(-50%) translateY(-400px) scale(0.5); opacity: 0; }
	  30% { transform: translateX(-50%) translateY(-200px) scale(1.3); opacity: 1; } /* 第一次彈跳高點 */
	  50% { transform: translateX(-50%) translateY(0px) scale(1); } /* 第一次落地 */
	  65% { transform: translateX(-50%) translateY(-150px) scale(1.1); } /* 第二次彈跳高點 */
	  80% { transform: translateX(-50%) translateY(0px) scale(1); } /* 第二次落地 */
	  90% { transform: translateX(-50%) translateY(-60px) scale(1.06); } /* 第三次彈跳高點 */
	  100% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; } /* 最後落地 */
	}

    @keyframes reveal {
      0% { transform: translateX(-50%) scale(0); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    @keyframes flash {
      0%, 100% { background-color: #ff6f61; }
      50% { background-color: #ffe066; }
    }

	
    .flash-bg {
      animation: flash 0.2s alternate 10;
    }

    .ssr-effect {
      color: #000000;
      background: #ffd700;
      border: 4px solid gold;
      text-shadow: 0 0 10px #FFD700, 0 0 20px #FF69B4;
      box-shadow: 0 0 30px #FFD700;
      animation: ssrGlow 1s ease-in-out infinite alternate;
    }

    @keyframes ssrGlow {
      from { transform: translateX(-50%) scale(1); opacity: 1; }
      to { transform: translateX(-50%) scale(1.1); opacity: 0.85; }
    }
  </style>
</head>
<body>
  <button class="settings-btn" onclick="toggleSettings(); event.stopPropagation()">⚙️</button>
  <div class="settings-panel" id="settingsPanel">
    <textarea id="inputPrizes" placeholder="輸入扭蛋內容，如：\n[特獎]*1\n一頒獎*2"></textarea>
    <div>
      <label><input type="checkbox" id="removeAfterDraw"/> 抽到後刪除</label>
    </div>
    <button onclick="updatePrizes()">更新</button>
  </div>

  <div >
    
	
	<div class="gacha-machine-wrapper">
		
		<div class="gacha-machine">
		  <div class="remaining-count" id="remainingCount">BALLS LEFT: 0</div>
		  <div class="gacha-balls" id="gachaBalls">
			
		  </div>
		  <div class="selected-ball" id="selectedBall"></div>
		  <div class="gacha-result" id="result"></div>
		</div>
	</div>
    
    <button class="gacha-button" id="gachaButton" onclick="spinGacha()"> START </button>
  </div>

  <audio id="drawSound" src="https://www.soundjay.com/button/sounds/button-3.mp3" preload="auto"></audio>

  <script>
    let prizePool = [];
    let rawInput = "[特獎]*1\n二獎*2\n三獎*5";
    let removeAfterDrawState = true;

    function parsePrizeInput(input) {
      const lines = input.trim().split('\n');
      const result = [];
      lines.forEach(line => {
        const match = line.match(/^(.+?)(\*(\d+))?$/);
        if (match) {
          const name = match[1].trim();
          const count = parseInt(match[3] || 1);
          for (let i = 0; i < count; i++) result.push(name);
        }
      });
      return result;
    }

    function updatePrizePoolDisplay() {
      const remaining = prizePool.length;
      document.getElementById("remainingCount").textContent = `BALLS LEFT : ${remaining}`;
    }

    function updatePrizes() {
      const input = document.getElementById("inputPrizes").value;
      rawInput = input;
      removeAfterDrawState = document.getElementById("removeAfterDraw").checked;
      prizePool = parsePrizeInput(input);
      updatePrizePoolDisplay();
      toggleSettings(true);
    }

    function toggleSettings(forceClose = null) {
      const panel = document.getElementById("settingsPanel");
      const resultElement = document.getElementById("result");
      resultElement.style.display = 'none';
      resultElement.style.opacity = '0';
      const shouldDisplay = forceClose === null ? panel.style.display !== "block" : !forceClose;

      if (shouldDisplay) {
        document.getElementById("inputPrizes").value = rawInput;
        document.getElementById("removeAfterDraw").checked = removeAfterDrawState;
        panel.style.display = "block";
      } else {
        panel.style.display = "none";
      }
    }

    document.addEventListener("click", function (e) {
      const panel = document.getElementById("settingsPanel");
      const settingsBtn = document.querySelector(".settings-btn");
      if (!panel.contains(e.target) && !settingsBtn.contains(e.target)) {
        toggleSettings(true);
      }
    });

    function getRandomColor() {
      const colors = ['#ffd700', '#66ccff', '#ff99cc', '#ff6666', '#cc99ff', '#99ff99'];
      const random = () => colors[Math.floor(Math.random() * colors.length)];
      return `radial-gradient(circle, #fff 30%, ${random()} 70%)`;
    }

    function isSSRPrize(name) {
      return name.startsWith("[") && name.endsWith("]");
    }

    function cleanPrizeName(name) {
      return name.replace(/^\[|\]$/g, "");
    }

    function spinGacha() {
      const gachaButton = document.getElementById('gachaButton');
      const gachaBalls = document.getElementById('gachaBalls');
      const selectedBall = document.getElementById('selectedBall');
      const resultElement = document.getElementById('result');
      const machine = document.querySelector('.gacha-machine');
      const removeAfterDraw = removeAfterDrawState;

      resultElement.style.display = 'none';
      selectedBall.style.display = 'none';
      resultElement.classList.remove("ssr-effect");

      if (prizePool.length === 0) {
        alert("目前沒有扭蛋可以抽囉！");
        return;
      }

      document.getElementById("drawSound").play();
      gachaButton.disabled = true;
      gachaBalls.classList.add('shake');

      setTimeout(() => {
        gachaBalls.classList.remove('shake');
        selectedBall.style.background = getRandomColor();
        selectedBall.style.display = 'block';

        const randomIndex = Math.floor(Math.random() * prizePool.length);
        const rawPrize = prizePool[randomIndex];
        const isSSR = isSSRPrize(rawPrize);
        const prize = cleanPrizeName(rawPrize);

        if (isSSR) {
          machine.classList.add('flash-bg');
        }

        setTimeout(() => {
          resultElement.textContent = prize;
          resultElement.style.display = 'block';
          resultElement.classList.toggle("ssr-effect", isSSR);
          gachaButton.disabled = false;

          if (removeAfterDraw) {
            prizePool.splice(randomIndex, 1);
            updatePrizePoolDisplay();
          }

          setTimeout(() => {
            machine.classList.remove('flash-bg');
          }, 2000);
        }, 1000);
      }, 1000);
    }

    window.onload = () => {
      document.getElementById('inputPrizes').value = rawInput;
      document.getElementById('removeAfterDraw').checked = removeAfterDrawState;
      updatePrizes();
    };
  </script>
</body>
</html>
